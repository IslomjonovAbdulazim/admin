import{r,u as $,a as q,o as R,j as e,g as B,B as y,n as M,s as F,t as f}from"./index-C2efy-H1.js";import{u as v,a as _,L as S,I as w}from"./label-Di6lIgUh.js";import{u as D,C as k,a as V,b as L,c as P,d as T}from"./card-C7FjlU42.js";import{c as W,a as z,b as I}from"./Combination-e_ExlZZi.js";import{S as U,a as H,b as K,c as Q,d as G}from"./select-Cb8MxY2o.js";import{B as J}from"./badge-D2ECJKXf.js";import{P as O}from"./phone-d7cTxiEk.js";import"./index-DM0Fh7Vv.js";/**
 * @license lucide-react v0.542.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Y=[["path",{d:"M20 13c0 5-3.5 7.5-7.66 8.95a1 1 0 0 1-.67-.01C7.5 20.5 4 18 4 13V6a1 1 0 0 1 1-1c2 0 4.5-1.2 6.24-2.72a1.17 1.17 0 0 1 1.52 0C14.51 3.81 17 5 19 5a1 1 0 0 1 1 1z",key:"oel41y"}],["path",{d:"m9 12 2 2 4-4",key:"dzmm74"}]],Z=W("shield-check",Y),ee={list:async()=>(await z.get("/api/v1/auth/learning-centers")).data};function se({initialTime:m,onComplete:g}){const[t,i]=r.useState(m),[c,u]=r.useState(!1),j=r.useCallback(l=>{i(l??m),u(!0)},[m]),x=r.useCallback(()=>{u(!1),i(0)},[]),n=r.useCallback(()=>{u(!1),i(m)},[m]);r.useEffect(()=>{let l;return c&&t>0&&(l=setInterval(()=>{i(o=>o<=1?(u(!1),0):o-1e3)},1e3)),()=>clearInterval(l)},[c,t,g]);const b=r.useCallback(l=>{const o=Math.floor(l/1e3),h=Math.floor(o/60),a=o%60;return h>0?`${h}:${a.toString().padStart(2,"0")}`:`${a}s`},[]);return{timeLeft:t,isActive:c,start:j,stop:x,reset:n,formatTime:()=>b(t)}}const te=R({phone:F().min(1,"Phone number is required").regex(/^\+998\d{9}$/,"Please enter a valid Uzbek phone number (+998XXXXXXXXX)"),learning_center_id:M().min(1,"Please select a learning center")}),ne=R({code:F().min(6,"Verification code must be 6 digits").max(6,"Verification code must be 6 digits").regex(/^\d{6}$/,"Verification code must contain only numbers")});function ae(){const[m,g]=r.useState("phone"),[t,i]=r.useState(!1),[c,u]=r.useState(null),j=$(),{auth:x,phoneVerification:n}=q(),{data:b=[]}=D({queryKey:["learning-centers-public"],queryFn:()=>ee.list()}),{isActive:l,start:o,formatTime:h}=se({initialTime:n.getWaitTime(),onComplete:()=>{}}),a=v({resolver:_(te),defaultValues:{phone:"",learning_center_id:0}}),p=v({resolver:_(ne),defaultValues:{code:""}});r.useEffect(()=>{const s=n.getWaitTime();s>0&&o(s)},[n,o]);const N=async s=>{if(!n.canRetry()){f.error(`Please wait ${h()} before requesting another code`);return}i(!0);try{await I.sendCode({phone:s.phone,learning_center_id:s.learning_center_id}),u(s),n.incrementRetryCount(),o(n.getWaitTime()),g("code"),f.success("Verification code sent to your phone!")}catch(d){const C=d.response?.data?.message||"Failed to send verification code. Please try again.";f.error(C)}finally{i(!1)}},X=async s=>{if(c){i(!0);try{const d=await I.verifyLogin({phone:c.phone,code:s.code,learning_center_id:c.learning_center_id});x.setUser(d.user),x.setTokens(d.access_token,d.refresh_token),n.clearRetryData(),f.success("Login successful!"),j({to:"/"})}catch(d){const C=d.response?.data?.message||"Invalid verification code. Please try again.";f.error(C)}finally{i(!1)}}},A=()=>{c&&n.canRetry()&&N(c)},E=()=>{g("phone"),u(null),p.reset()};return m==="phone"?e.jsx("div",{className:"min-h-screen flex items-center justify-center bg-background p-4",children:e.jsxs(k,{className:"w-full max-w-md",children:[e.jsxs(V,{className:"space-y-1",children:[e.jsxs(L,{className:"text-2xl text-center flex items-center justify-center gap-2",children:[e.jsx(O,{className:"h-5 w-5"}),"Admin Login"]}),e.jsx(P,{className:"text-center",children:"Enter your phone number and select your learning center"})]}),e.jsx(T,{children:e.jsxs("form",{onSubmit:a.handleSubmit(N),className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(S,{htmlFor:"learning_center_id",children:"Learning Center"}),e.jsxs(U,{value:a.watch("learning_center_id")?.toString()||"",onValueChange:s=>a.setValue("learning_center_id",parseInt(s)),disabled:t,children:[e.jsx(H,{children:e.jsx(K,{placeholder:"Select learning center"})}),e.jsx(Q,{children:b.map(s=>e.jsx(G,{value:s.id.toString(),children:e.jsxs("div",{className:"flex items-center gap-2",children:[s.logo&&e.jsx("img",{src:B(s.logo)||"",alt:s.name,className:"w-4 h-4 rounded-full object-cover",onError:d=>{d.currentTarget.style.display="none"}}),s.name]})},s.id))})]}),a.formState.errors.learning_center_id&&e.jsx("p",{className:"text-sm text-destructive",children:a.formState.errors.learning_center_id.message})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(S,{htmlFor:"phone",children:"Phone Number"}),e.jsx(w,{id:"phone",type:"tel",placeholder:"+998901234567",...a.register("phone"),disabled:t}),a.formState.errors.phone&&e.jsx("p",{className:"text-sm text-destructive",children:a.formState.errors.phone.message})]}),n.retryCount>0&&l&&e.jsx("div",{className:"text-center",children:e.jsxs(J,{variant:"secondary",className:"text-xs",children:["Wait ",h()," to request new code"]})}),e.jsx(y,{type:"submit",className:"w-full",disabled:t||!n.canRetry(),children:t?"Sending Code...":"Send Verification Code"})]})})]})}):e.jsx("div",{className:"min-h-screen flex items-center justify-center bg-background p-4",children:e.jsxs(k,{className:"w-full max-w-md",children:[e.jsxs(V,{className:"space-y-1",children:[e.jsxs(L,{className:"text-2xl text-center flex items-center justify-center gap-2",children:[e.jsx(Z,{className:"h-5 w-5"}),"Verify Code"]}),e.jsxs(P,{className:"text-center",children:["Enter the 6-digit code sent to ",c?.phone]})]}),e.jsx(T,{children:e.jsxs("form",{onSubmit:p.handleSubmit(X),className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(S,{htmlFor:"code",children:"Verification Code"}),e.jsx(w,{id:"code",type:"text",placeholder:"123456",maxLength:6,className:"text-center text-lg tracking-widest",...p.register("code"),disabled:t,autoFocus:!0}),p.formState.errors.code&&e.jsx("p",{className:"text-sm text-destructive",children:p.formState.errors.code.message})]}),e.jsx(y,{type:"submit",className:"w-full",disabled:t,children:t?"Verifying...":"Verify & Login"}),e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsx(y,{type:"button",variant:"outline",onClick:A,disabled:t||!n.canRetry(),className:"w-full",children:l?`Resend Code (${h()})`:"Resend Code"}),e.jsx(y,{type:"button",variant:"ghost",onClick:E,disabled:t,className:"w-full",children:"Change Phone Number"})]})]})})]})})}const he=ae;export{he as component};
